
<!Doctype html>
<html>
<head>
  <title> My Online CookBook </title>
  

  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  
  <style>
  * {
  box-sizing: border-box;
  font-family: 'Roboto', sans-serif;
  outline: none;
}

.page-title-span {
  margin-left: 10px;

}

.button-right-icon {
  
  margin-left: 10px;
}

#search {
  
  margin-top: 80px;
}

#saved {
  
  margin-top: 90px;
}

#history {
  
  margin-top: 100px;
}

/*#savetable {
  
  margin-top: 10px;
}
#tableview {
  
  margin-top: 10px;
}
*/



#searchip {
  
  margin-top: 10px;
}

#calorie {
  
  margin-top: 20px;
}

#protein {
  
  margin-top: 40px;
}

#fat {
  
  margin-top: 60px;
}



#sliderspace {
  
  margin-left: 22px;
}

.login-cover {
  background: #fff;
  position:fixed;
  top:0;
  left:0;
  width :100%;
  height : 100vh;
  z-index: 800;
  display: flex;
  justify-content: center;
  align-items: center;
}


#loginProgress{
  display: none;
}

#loginError{
  display: none;
}


 table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
}

th, td {
    padding: 15px;
}

table {
    border-spacing: 5px;
}

</style>
</head>
<body>


<dialog id="loginD" class="mdl-dialog">
    <h4 class="mdl-dialog__title">Sign In</h4>
    <div class="mdl-dialog__content">
      <p id="loginError"></p>
      <!-- Textfield with Floating Label -->
      <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
          <input class="mdl-textfield__input" type="text" id="loginEmail">
          <label class="mdl-textfield__label" for="sample3">Email</label>
      </div>
      <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
          <input class="mdl-textfield__input" type="password" id="loginPassword">
          <label class="mdl-textfield__label" for="sample3">Password</label>
      </div>
    </div>
    <div class="mdl-dialog__actions">
        <button id ="loginBtn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
        Sign In
        </button>
         <button id ="signupBtn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
        Sign Up
        </button>
        <div id = "loginProgress" class="mdl-spinner mdl-js-spinner is-active"></div>
     </div>    
</dialog>



 <div class="login-cover">
    <div class="page-loader mdl-spinner mdl-js-spinner is-active"></div>
 </div>



  <div class="mdl-layout mdl-js-layout">
  <header class="mdl-layout__header">
    <div class="mdl-layout-icon"></div>
    <div class="mdl-layout__header-row">
      <span class="mdl-layout__title">My Cook Book
        <span class="page-title-span"> | </span>
        <span class="page-title-span"> HOME </span>
      </span>
      <div class="mdl-layout-spacer"></div>
      <nav class="mdl-navigation">
        <!-- Accent-colored raised button -->
          <button id="signOutBtn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent">
            Sign Out <i class="button-right-icon material-icons">account_circle</i>
          </button>
      </nav>
    </div>
  </header>





 <div id="mainpage">
  <table  style="width:100%" >
    <thead>
        <tr>
            <td><b>Title</b></td>
            <td><b>Fat (gm)</b></td>
            <td><b>Protein (gm)</b></td>
            <td><b>Calories (KCal)</b></td>
            <td><b>Rating</b></td>
            <td><b>View</b></td>
        </tr>
    </thead>
    <tbody id="ex-table">
    </tbody>
    </table>
 </div>

 <div id = "tableview" style="display:none">
    <h4><b>Title</b></h4>
    <h4 id ="rec_title"></h4>
    <h4><b><i>Ingredients</i></b></h4>
    <h4 id ="rec_ingr" ></h4>
    <h4><b><i>Recipe</i></b></h4>
    <h4 id ="rec_rec"></h4>
    <button id="back" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent"  onclick='backs();'> Return </button>
</div> 

 <div id="hist_page" style="display:none">

       <div id="savetable">

              <table  style="width:100%" id='mytable' >
              <thead>
              <tr>
              <td><b>Name</b></td>
              <td><b>View</b></td>
              <td><b>Delete</b></td>
              </tr>
              </thead>
              <tbody id="savetableid">
              </tbody>
              </table>

        </div>

     <button id="back" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent"  onclick='backs();'> Return </button>
    </div>


   






<div class="mdl-layout__drawer">

<!-- List items with avatar and action -->
<style>
.demo-list-action {
  width: 300px;
}
</style>



<find action="#">
  <div id="searchip" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
    <input class="mdl-textfield__input" type="text" id="keyword">
    <label class="mdl-textfield__label" for="sample3">Search Recipe Title....</label>
  </div>
</find>

<p id="calorie" style="width:250px">
<input class="mdl-slider mdl-js-slider" type="range" id="sc" min="0" max="9" value="0" step="1">
<h8 id="sliderspace">         Calories        </h8>
</p>

<p id="protein" style="width:250px">
<input class="mdl-slider mdl-js-slider" type="range" id="sp" min="0" max="9" value="0" step="1">
<h8 id="sliderspace">         Protein         </h8>
</p>

<p id="fat" style="width:250px">
<input class="mdl-slider mdl-js-slider" type="range" id="sf" min="0" max="9" value="0" step="1">
<h8 id="sliderspace">          Fat         </h8>
</p>

<button id="search" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent">
  Search
</button>

<button id="saved" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
  Save
</button>

<button id="history" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored"   onclick='hist();'>
  History
</button>







   </div>
 </div>
  
 












   <!-- Linking to firebase database -->

    <script src="https://code.jquery.com/jquery-3.1.0.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.11.0/firebase.js"></script>

    <script>
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyAqbIIf-Wno5C5AMecMnwz7HO5czt8atTw",
        authDomain: "dmhw1-28e4c.firebaseapp.com",
        databaseURL: "https://dmhw1-28e4c.firebaseio.com",
        projectId: "dmhw1-28e4c",
        storageBucket: "dmhw1-28e4c.appspot.com",
        messagingSenderId: "90711227041"
      };
      firebase.initializeApp(config);
    </script>

    
    <script>
         
          firebase.auth().onAuthStateChanged(function(user){
                   if (user) {

                   $(".login-cover").hide();

                   var dialog = document.querySelector('#loginD');
                   if (! dialog.showModal) {
                    dialogPolyfill.registerDialog(dialog);
                     }

                     dialog.close();


                 } 
                 else {
                      
                      $(".login-cover").show();

                   var dialog = document.querySelector('#loginD');
                   if (! dialog.showModal) {
                    dialogPolyfill.registerDialog(dialog);
                     }
                      dialog.showModal();
                     }

                  }); 





$("#loginBtn").click(
  function(){
       var email = $("#loginEmail").val();
       var password = $("#loginPassword").val();

       if(email != "" && password !=  ""){
        $("#loginProgress").show();
        $("#loginBtn").hide();

        firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
        // Handle Errors here.
       $("#loginError").show().text(error.message);
       $("#loginProgress").hide();
       $("#loginBtn").show();
       });
       }

  }
);

$("#signupBtn").click(
  function(){
       var email = $("#loginEmail").val();
       var password = $("#loginPassword").val();

       if(email != "" && password !=  ""){
        $("#loginProgress").show();
        $("#loginBtn").hide();

        firebase.auth().createUserWithEmailAndPassword(email, password).catch(function(error) {
        // Handle Errors here.
       $("#loginError").show().text(error.message);
       $("#loginProgress").hide();
       $("#loginBtn").show();
       });
       }

  }
);









$("#signOutBtn").click(
   function(){
   firebase.auth().signOut().then(function(){

   }, function(error){
   
   alert(error.message);

  });

  }

);

  
 














$("#add").click(
    function(){
    var firebaseref = firebase.database().ref();
    firebase.auth().onAuthStateChanged((user) => {
    if (user) {
    var parent = (user.uid) ;
    firebaseref.child(parent).set("null")

    }
    });
   }
  );

$("#delete").click(
    function(){
    var firebaseref = firebase.database().ref();
    firebase.auth().onAuthStateChanged((user) => {
    if (user) {
    var parent = (user.uid) ;
    firebaseref.child(parent).set("null")
    }
    });
   }
  );





$("#search").click(
   function(){

      var cv = sc.value;
      var fv = sf.value;
      var pv = sp.value;
      var eng = keyword.value;
      searchKeywords(cv,fv,pv,eng);
      console.log("hi");
   }
  );


$("#saved").click(
   function(){
            
            $('#savetableid tr').remove();
            var cv = sc.value;
            var fv = sf.value;
            var pv = sp.value;
            var eng = keyword.value;
            saveKeywords(cv,fv,pv,eng);
            alert('Search Saved');
      console.log("hi");
         }
  );



   function backs(event) {

   document.getElementById("mainpage").style.display="block";
   document.getElementById("tableview").style.display="none";
   document.getElementById("hist_page").style.display="none";


     } 


    function hist(event) {

   document.getElementById("hist_page").style.display="block";
   document.getElementById("mainpage").style.display="none";
   document.getElementById("tableview").style.display="none";

   $('#savetableid tr').remove();

    var firebaseref = firebase.database().ref();

    firebase.auth().onAuthStateChanged((user) => {
    if (user) {
    var parent = (user.uid) ;
    console.log(parent);
    var firebaserefafter = firebase.database().ref(parent);
    console.log(firebaserefafter);


     firebaserefafter.on('value',function(snapshot1){
    if(snapshot1.exists()){
      for (snap in snapshot1.val()){
       snap_key = snap;
       snap_val = snapshot1.val()[snap]
       snaps2 = snapshot1.val()[snap];
       var eng =  snap_key;
       var key = eng;
       var content1 = '';
       content1 += '<tr>';
       content1 += '<td>' + snap_key + '</td>';
       var dip5 = firebaserefafter;
       var dip6 = snap_key;
       var dip7 = snap_val;
       content1 += "<td><button id='find'    disp5_val= '"+dip5+"' disp6_val= '"+dip6+"'  disp7_val= '"+dip7+"'    onclick='viewClicksave(this);'> search </button></td>";
       content1 += "<td><button id='remove'  disp5_val= '"+dip5+"' disp6_val= '"+dip6+"'    onclick='removeit(this);'> remove </button></td>";
       content1 += '</tr>';
       $('#savetableid').append(content1);









      }

    }

  });
     }
   });



                        } 





function viewClick(event) {

   document.getElementById("tableview").style.display="block";
   document.getElementById("mainpage").style.display="none";
   document.getElementById("hist_page").style.display="none";
   



   var display_value  = event.getAttribute('disp_val');
   var rec_title = document.getElementById("rec_title");
   rec_title.innerText = display_value;

   var display_value1  = event.getAttribute('disp1_val');
   var rec_ingr = document.getElementById("rec_ingr");
   rec_ingr.innerText = display_value1;

   var display_value2  = event.getAttribute('disp2_val');
   var rec_rec = document.getElementById("rec_rec");
   rec_rec.innerText = display_value2;

     }  





  function viewClicksave(event) {


  document.getElementById("mainpage").style.display="block";
  document.getElementById("tableview").style.display="none";
  document.getElementById("hist_page").style.display="none";

  var display_value3  = event.getAttribute('disp3_val');
  var display_value4  = event.getAttribute('disp4_val');
  var display_value5  = event.getAttribute('disp5_val');
  var display_value6  = event.getAttribute('disp6_val');
  var snaps2 = event.getAttribute('disp7_val');
  snaps2 = snaps2.split(',');
     
     $('#ex-table tr').remove();

         for (snap in snaps2){
                   var query = '/project/data/' + snaps2[snap];
                   var recipes = firebase.database().ref(query);
                    recipes.once('value',function(snapshot2){
                        if(snapshot2.exists()){
                            var content = '';
                            content += '<tr>';
                            content += '<td>' + snapshot2.val().title + '</td>';
                            content += '<td>' + snapshot2.val().fat_val + '</td>';
                            content += '<td>' + snapshot2.val().protein_val + '</td>';
                            content += '<td>' + snapshot2.val().calories_val + '</td>';
                            content += '<td>' + snapshot2.val().rating + '</td>';
                            var dip  = snapshot2.val().title.toString();
                            var dip1 = snapshot2.val().ingredients.toString();
                            var dip2 = snapshot2.val().directions.toString();
                            window.special_dip = dip;
                            window.special_dip1 = dip1;
                            window.special_dip2 = dip2;
                            content += "<td><button id='view' disp_val='"+dip+"' disp1_val='"+dip1+"' disp2_val='"+dip2+"'  onclick='viewClick(this);'> view </button></td>";
                            content += '</tr>';
                            $('#ex-table').append(content);

                        }
                    }); 
                }
     
    }






  function removeit(event) {

  var display_value3  = event.getAttribute('disp3_val');
  var display_value4  = event.getAttribute('disp4_val');
  var display_value5  = event.getAttribute('disp5_val');
  var display_value6  = event.getAttribute('disp6_val');
  var snaps2          = event.getAttribute('disp7_val');

                var ref = display_value5;
                var firebaseref = firebase.database().ref();
                firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                var parent = (user.uid) ;
                var firebaserefafter = firebase.database().ref(parent)
                firebaserefafter.child(display_value6).remove();
                }
                });
                
                alert("Removed");
                
               hist();

        }
      
    </script>


<script>     


                     //--------
            // Adapted from -> https://gist.github.com/axelpale/3118596
            function k_combinations(set, k) {
                var i, j, combs, head, tailcombs;
                if (k > set.length || k <= 0) {
                    return [];
                }
                if (k == set.length) {
                    return [set];
                }
                if (k == 1) {
                    combs = [];
                    for (i = 0; i < set.length; i++) {
                        combs.push([set[i]]);
                    }
                    return combs;
                }
                combs = [];
                for (i = 0; i < set.length - k + 1; i++) {
                    head = set.slice(i, i + 1);
                    tailcombs = k_combinations(set.slice(i + 1), k - 1);
                    for (j = 0; j < tailcombs.length; j++) {
                        combs.push(head.concat(tailcombs[j]));
                    }
                }
                return combs;
            }
            //--------
            // Adapted from -> https://gist.github.com/axelpale/3118596
            function combinations(set) {
                var k, i, combs, k_combs;
                combs = [];
                for (k = 1; k <= set.length; k++) {
                    k_combs = k_combinations(set, k);
                    for (i = 0; i < k_combs.length; i++) {
                        combs.push(k_combs[i]);
                    }
                }
                return combs;
            }


            function intersect(a, b) {
                var t;
                if (b.length > a.length) t = b, b = a, a = t; // indexOf to loop over shorter
                return a.filter(function (e) {
                    return b.indexOf(e) > -1;
                });
            }


            //--------Added parameter w
            function allCallbackCompleted(snaps1,w) {
                //----------
                var snaps2 = [];
                var temp = [];
                var w_range = [];
                for (i=0;i<w;i++){
                    temp.push(snaps1[i]);
                    w_range.push(i);
                }
                var res1 = combinations(w_range);
                for (i=res1.length-1;i>=0;i--){
                    var res2 = res1[i];
                    var res3 = temp[res2[0]];
                    if (res2.length>1){
                        for (j=1;j<res2.length;j++){
                            res3 = intersect(res3,temp[res2[j]]);
                        }
                    }
                    for (res in res3){
                        if (snaps2.includes(res3[res])==false){
                            snaps2.push(res3[res]);
                        }
                    }
                }
                if(snaps1.length > w){
                    for(i=w;i<snaps1.length;i++){
                        snaps2 = intersect(snaps2,snaps1[i]);
                    }
                }
                for (snap in snaps2){
                    var query = '/project/data/' + snaps2[snap];
                    var recipes = firebase.database().ref(query);
                    recipes.once('value',function(snapshot2){
                        if(snapshot2.exists()){
                            var content = '';
                            content += '<tr>';
                            content += '<td>' + snapshot2.val().title + '</td>';
                            content += '<td>' + snapshot2.val().fat_val + '</td>';
                            content += '<td>' + snapshot2.val().protein_val + '</td>';
                            content += '<td>' + snapshot2.val().calories_val + '</td>';
                            content += '<td>' + snapshot2.val().rating + '</td>';
                            var dip  = snapshot2.val().title.toString();
                            var dip1 = snapshot2.val().ingredients.toString();
                            var dip2 = snapshot2.val().directions.toString();
                            window.special_dip = dip;
                            window.special_dip1 = dip1;
                            window.special_dip2 = dip2;
                            content += "<td><button id='view' disp_val='"+dip+"' disp1_val='"+dip1+"' disp2_val='"+dip2+"'  onclick='viewClick(this);'> view </button></td>";
                            content += '</tr>';
                            $('#ex-table').append(content);
                        }
                    }); 
                }

            }
            
            function searchKeywords(cv,fv,pv,eng) {
                $('#ex-table tr').remove();
                var keyword = eng;
                var calories = cv;
                var fat = fv;
                var protein = pv;
                if(keyword == "" && calories == '0' && fat == '0' && protein == '0'){
                    alert("Not Found")
                    return;
                }
                var keywords = [];
                if (keyword !=  ""){
                    keywords = keywords.concat(keyword.split(" "));
                }
                if (calories != '0'){
                    calories = 'caloriez' + calories;
                    keywords.push(calories);
                }
                if (fat != '0'){
                    fat = 'fatz' + fat;
                    keywords.push(fat);
                }
                if (protein != '0'){
                    protein = 'proteinz' + protein;
                    keywords.push(protein);
                }
               var snaps1 = [];
                //--------
                var w = 0;
                for (k in keywords){
                    
                    (function(keywords, k) {
                        
                        if (keywords[k].startsWith('caloriez')){
                            var query = '/project/cal_inv_index/' + keywords[k][keywords[k].length-1];
                        }
                        else if (keywords[k].startsWith('fatz')){
                            var query = '/project/fat_inv_index/' + keywords[k][keywords[k].length-1];
                        }
                        else if (keywords[k].startsWith('proteinz')){
                            var query = '/project/pro_inv_index/' + keywords[k][keywords[k].length-1];
                        }
                        else{
                            var query = '/project/inv_index/' + keywords[k];
                        }
                        var indices = firebase.database().ref(query);
                        indices.on('value', function(snapshot1){
                            if(snapshot1.exists()){
                                snaps1.push(snapshot1.val());
                            }
                            //--------
                            if(snapshot1.exists() && keywords[k].startsWith('caloriez') == false &&
                              keywords[k].startsWith('fatz') == false && keywords[k].startsWith('proteinz') == false){
                                w = w + 1;
                            }
                            if (k == keywords.length - 1){
                                //--------
                                allCallbackCompleted(snaps1,w)
                            }
                    });
                        
                    })(keywords, k);
                }
            } 



            function allCallbackCompleted1(snaps1,w,eng) {
                var snaps2 = [];
                var temp = [];
                var w_range = [];
                for (i=0;i<w;i++){
                    temp.push(snaps1[i]);
                    w_range.push(i);
                }
                var res1 = combinations(w_range);
                for (i=res1.length-1;i>=0;i--){
                    var res2 = res1[i];
                    var res3 = temp[res2[0]];
                    if (res2.length>1){
                        for (j=1;j<res2.length;j++){
                            res3 = intersect(res3,temp[res2[j]]);
                        }
                    }
                    for (res in res3){
                        if (snaps2.includes(res3[res])==false){
                            snaps2.push(res3[res]);
                        }
                    }
                }
                if(snaps1.length > w){
                    for(i=w;i<snaps1.length;i++){
                        snaps2 = intersect(snaps2,snaps1[i]);
                    }
                }

                        var firebaseref = firebase.database().ref();
                        firebase.auth().onAuthStateChanged((user) => {
                        if (user) {
                        var parent = (user.uid) ;
                        console.log(parent);
                        //firebaseref.child(parent).set("null")
                        var firebaserefafter = firebase.database().ref(parent)
                        var key = eng;
                        var obj = {};
                        obj[key] = snaps2;
                       console.log(firebaserefafter);
                        firebaserefafter.update(obj);
                        //firebaserefafter.child(eng).set(snaps2);

                        //var firebaserefafter = firebaseref.child(parent) 
                        //firebaserefafter.update().set(obj);

                           

                           
                           }
                    });
               
            }


             function saveKeywords(cv,fv,pv,eng) {
                var keyword = eng;
                var calories = cv;
                var fat = fv;
                var protein = pv;
                if(keyword == "" && calories == '0' && fat == '0' && protein == '0'){
                    alert("Not Found")
                    return;
                }
                var keywords = [];
                if (keyword !=  ""){
                    keywords = keywords.concat(keyword.split(" "));
                }
                if (calories != '0'){
                    calories = 'caloriez' + calories;
                    keywords.push(calories);
                }
                if (fat != '0'){
                    fat = 'fatz' + fat;
                    keywords.push(fat);
                }
                if (protein != '0'){
                    protein = 'proteinz' + protein;
                    keywords.push(protein);
                }
                var snaps1 = [];
                //--------
                var w = 0;
                for (k in keywords){
                    
                    (function(keywords, k) {
                        
                        if (keywords[k].startsWith('caloriez')){
                            var query = '/project/cal_inv_index/' + keywords[k][keywords[k].length-1];
                        }
                        else if (keywords[k].startsWith('fatz')){
                            var query = '/project/fat_inv_index/' + keywords[k][keywords[k].length-1];
                        }
                        else if (keywords[k].startsWith('proteinz')){
                            var query = '/project/pro_inv_index/' + keywords[k][keywords[k].length-1];
                        }
                        else{
                            var query = '/project/inv_index/' + keywords[k];
                        }
                        var indices = firebase.database().ref(query);
                        indices.on('value', function(snapshot1){
                            if(snapshot1.exists()){
                                snaps1.push(snapshot1.val());
                            }
                            //--------
                            if(snapshot1.exists() && keywords[k].startsWith('caloriez') == false &&
                              keywords[k].startsWith('fatz') == false && keywords[k].startsWith('proteinz') == false){
                                w = w + 1;
                            }
                            if (k == keywords.length - 1){
                                //--------
                                allCallbackCompleted1(snaps1,w,eng)
                            }
                    });
                        
                    })(keywords, k);
                }
            } 





        </script>

 </body>
 </html>